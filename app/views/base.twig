<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta http-equiv="content-language" content="ko-kr">
    <title>Seal Seek See</title>

    <link rel="stylesheet" href="/static/fonts/font.css" type="text/css">
    <link rel="stylesheet" href="/static/fonts/themify-icons.css">
    <link rel="stylesheet" href="/static/css/base.css">
    <style type="text/css">
        /* 편지 쓸 때, 지도 중간에 뜨는 마커 추가 */
        #map_for_write_letter:after {
            width: 22px;
            height: 40px;
            display: block;
            content: ' ';
            position: absolute;
            top: 50%; left: 50%;
            margin: -40px 0 0 -11px;
            background: url('/static/images/spotlight-poi_hdpi.png');
            background-size: 22px 40px;
            pointer-events: none;
        }
    </style>
    <script src="/static/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="/static/node_modules/autosize/dist/autosize.min.js"></script>
    <script>
        var activePage = function(target) {
            $('#header').toggleClass('disactive', (target === 'home'));
            $("[id^=page_]").removeClass('active');
            $("#page_" + target).addClass('active')
        };

        $(function() {
            {# TODO: 홈으로 올 때 모든 데이터 초기화? #}
            $('.js_page_toggle').on('click', function(e) {
                var _target = $(e.target);
                if (!_target.is('button')) {
                    _target = _target.parents('.js_page_toggle').eq(0);
                }
                var target = _target.data('target');
                activePage(target);
            });

            autosize($('.js_auto_resize'));
        })
    </script>
</head>
<body>
<header id="header" class="top_nav_header disactive">
    {# TODO: 뒤로가기 이미지 교체. 홈 버튼으로 바꾸자 #}
    <button class="history_back_button js_page_toggle" type="button" data-target="home">
        <span class="history_back_button_icon ti-angle-left"></span>
    </button>
</header>
{% include 'index.twig' %}

{% include 'write_letter.twig' %}

{% include 'find_letter.twig' %}

{% include 'find_letter_map.twig' %}

{% include 'read_letter.twig' %}

<div class="cover_loading">
    <div class="spinner">
        <div class="dot1"></div>
        <div class="dot2"></div>
    </div>
</div>

<script type="text/javascript">
    // 연세대학교 제3공학관
    var yonseiCoords = {
        lat: 37.561741,
        lng: 126.935105
    };

    var writeLetterCoords = {
        lat: yonseiCoords.lat,
        lng: yonseiCoords.lng
    };

    var mapForWriteLetter = null;
    var mapForFindLetter = null;

    var myMarker = null;
    var letterMarker = null;
    var geolocationWatchID = null;

    var letterMetadata = null;

    function initMaps() {
        var mapOptions = {
            center: yonseiCoords,
            zoom: 16,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            zoomControl: true,
            mapTypeControl: false,
            scaleControl: true,
            streetViewControl: false,
            rotateControl: false
        };
        mapForWriteLetter = new google.maps.Map(document.getElementById("map_for_write_letter"), mapOptions);
        mapForFindLetter = new google.maps.Map(document.getElementById("map_for_find_letter"), mapOptions);
    }

    function initMapForWriteLetter() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                writeLetterCoords.lat = position.coords.latitude;
                writeLetterCoords.lng = position.coords.longitude;
                mapForWriteLetter.setCenter(writeLetterCoords);
            });
        }

        mapForWriteLetter.addListener("center_changed", function() {
            var center = mapForWriteLetter.getCenter();
            writeLetterCoords.lat = center.lat();
            writeLetterCoords.lng = center.lng();
        });
    }

    function initMapForFindLetter() {
        var letterPosition = {
            lat: Number(letterMetadata.latitude),
            lng: Number(letterMetadata.longitude)
        };
        letterMarker = new google.maps.Marker({
            position: letterPosition,
            map: mapForFindLetter
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                console.log("[Geolocation] Get... (" + position.coords.latitude + ", " + position.coords.longitude + ") (" + position.coords.accuracy + "m)");

                var myPosition = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                myMarker = new google.maps.Marker({
                    position: myPosition,
                    map: mapForFindLetter,
                    icon: 'https://maps.google.com/mapfiles/kml/shapes/library_maps.png'
                });

                var bounds = new google.maps.LatLngBounds();
                bounds.extend(myPosition);
                bounds.extend(letterPosition);
                mapForFindLetter.fitBounds(bounds);

                handleMyLocationUpdate(position);
                hideLoading();

                startWatchGelocationForFindLetter();
            }, function (error) {
                {# TODO: 우리 서비스 이용 못함 #}
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        console.log("Geolocation error: User denied the request for Geolocation.");
                        break;
                    case error.POSITION_UNAVAILABLE:
                        console.log("Geolocation error: Location information is unavailable.");
                        break;
                    case error.TIMEOUT:
                        console.log("Geolocation error: The request to get user location timed out.");
                        break;
                    default:
                        console.log("Geolocation error: An unknown error occurred.");
                        break;
                }
            });
        } else {
            {# TODO: 우리 서비스 이용 못함 #}
            console.log("Geolocation not available");
        }
    }

    function startWatchGelocationForFindLetter() {
        // Start watching
        geolocationWatchID = navigator.geolocation.watchPosition(function(position) {
            console.log("[Geolocation] Watching... (" + position.coords.latitude + ", " + position.coords.longitude + ") (" + position.coords.accuracy + "m)");
            // 오차 범위가 1km 보다 큰 경우 값을 무시한다.
            if (position.coords.accuracy > 1000) {
                return;
            }

            handleMyLocationUpdate(position);
        });
    }

    function handleMyLocationUpdate(position) {
        // 내 위치 업데이트
        myMarker.setPosition({
            lat: position.coords.latitude,
            lng: position.coords.longitude
        });

        // 내 위치와 편지 위치와의 거리 계산. 500m 이내인 경우에만 편지 읽을 수 있게
        var distance = google.maps.geometry.spherical.computeDistanceBetween(myMarker.getPosition(), letterMarker.getPosition());
        console.log("[GooleMap] Distance: " + distance + "m");

        var $readLetterButton = $("#read_letter_button");
        if (distance <= 500) {
            $readLetterButton.prop("disabled", false);
        } else {
            $readLetterButton.prop("disabled", true);
        }
    }

    function stopWatchGeolocationForFindLetter() {
        if (geolocationWatchID !== null) {
            navigator.geolocation.clearWatch(geolocationWatchID);
            geolocationWatchID = null;
        }
    }

    $(function() {
        $("#write_letter_button").click(function() {
            initMapForWriteLetter();
            activePage("send");
        });

        $("#write_letter_form").submit(function(event) {
            event.preventDefault();

            var $form = $(this);

            var $senderPhone1 = $form.find("select[name='sender_phone_number_1']");
            var $senderPhone2 = $form.find("input[name='sender_phone_number_2']");
            var $senderPhone3 = $form.find("input[name='sender_phone_number_3']");
            var usingSenderPhone = $senderPhone2.val().length > 0 || $senderPhone3.val().length > 0;

            var senderPhone = "";
            if (usingSenderPhone) {
                if (/^\d{3,4}$/.test($senderPhone2.val()) === false) {
                    alert("보내는 사람 번호가 올바르지 않습니다.");
                    $senderPhone2.focus();
                    return;
                }
                if (/^\d{4}$/.test($senderPhone3.val()) === false) {
                    alert("보내는 사람 번호가 올바르지 않습니다.");
                    $senderPhone3.focus();
                    return;
                }
                senderPhone = $senderPhone1.val() + "-" + $senderPhone2.val() + "-" + $senderPhone3.val();
            }

            var $receiverPhone1 = $form.find("select[name='receiver_phone_number_1']");
            var $receiverPhone2 = $form.find("input[name='receiver_phone_number_2']");
            var $receiverPhone3 = $form.find("input[name='receiver_phone_number_3']");
            var receiverPhone = $receiverPhone1.val() + "-" + $receiverPhone2.val() + "-" + $receiverPhone3.val();

            var $title = $form.find("input[name='title']");
            var $content = $form.find("textarea[name='content']");

            var params = {
                sender_phone: senderPhone,
                receiver_phone: receiverPhone,
                title: $title.val(),
                message: $content.val(),
                lat: writeLetterCoords.lat,
                lng: writeLetterCoords.lng
            };

            showLoading();
            $.post("/api/letter/write", params, function(data, textStatus, jqXHR) {
                hideLoading();
                alert(jqXHR.responseText);
                activePage("home");

                // 초기화
                $senderPhone1.val("010");
                $senderPhone2.val("");
                $senderPhone3.val("");

                $receiverPhone1.val("010");
                $receiverPhone2.val("");
                $receiverPhone3.val("");

                $title.val("");
                $content.val("");

                writeLetterCoords.lat = yonseiCoords.lat;
                writeLetterCoords.lng = yonseiCoords.lng;
                mapForWriteLetter.setCenter(writeLetterCoords);
            }).fail(function (jqXHR) {
                hideLoading();
                alert(jqXHR.responseText);
            });
        });

        $("#find_letter_form").submit(function(event) {
            event.preventDefault();

            var $form = $(this);

            var $receiverPhone1 = $form.find("select[name='receiver_phone_number_1']");
            var $receiverPhone2 = $form.find("input[name='receiver_phone_number_2']");
            var $receiverPhone3 = $form.find("input[name='receiver_phone_number_3']");
            var receiverPhone = $receiverPhone1.val() + "-" + $receiverPhone2.val() + "-" + $receiverPhone3.val();

            var $word1 = $form.find("input[name='location_word_1']");
            var $word2 = $form.find("input[name='location_word_2']");
            var $word3 = $form.find("input[name='location_word_3']");

            var params = {
                receiver_phone: receiverPhone,
                word1: $word1.val(),
                word2: $word2.val(),
                word3: $word3.val()
            };

            showLoading();
            $.post("/api/letter/find", params, function(data) {
                letterMetadata = data.letter_meta;
                initMapForFindLetter();
                activePage("find_on_map");

                // 초기화
                $receiverPhone1.val("010");
                $receiverPhone2.val("");
                $receiverPhone3.val("");

                $word1.val("");
                $word2.val("");
                $word3.val("");
            }).fail(function (jqXHR) {
                hideLoading();
                alert(jqXHR.responseText);
            });
        });

        $("#read_letter_button").click(function() {
            stopWatchGeolocationForFindLetter();
            console.log("[Geolocation] Watching stopped");
            {# TODO: Read API (opened date update) #}
            letterMetadata = null;

            letterMarker.setMap(null);
            myMarker.setMap(null);

            activePage("read");
        });
    });

    function showLoading() {
        $(".cover_loading").addClass("active");
    }

    function hideLoading() {
        $(".cover_loading").removeClass("active");
    }

</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBNNrE7tuvdbalbsD2Yr8AE4ZPFOyYRgzs&libraries=geometry&callback=initMaps" async defer></script>
</body>
</html>
