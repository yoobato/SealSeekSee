<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta http-equiv="content-language" content="ko-kr">
    <title>Seal Seek See</title>

    <link rel="stylesheet" href="/static/fonts/font.css" type="text/css">
    <link rel="stylesheet" href="/static/fonts/themify-icons.css">
    <link rel="stylesheet" href="/static/css/base.css">
    <style type="text/css">
        /* 편지 쓸 때, 지도 중간에 뜨는 마커 추가 */
        #map_for_write_letter:after {
            width: 22px;
            height: 40px;
            display: block;
            content: ' ';
            position: absolute;
            top: 50%; left: 50%;
            margin: -40px 0 0 -11px;
            background: url('/static/images/spotlight-poi_hdpi.png');
            background-size: 22px 40px;
            pointer-events: none;
        }
    </style>
    <script src="/static/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="/static/node_modules/autosize/dist/autosize.min.js"></script>
    <script>
        var activePage = function(target) {
            $('#header').toggleClass('disactive', (target === 'home'));
            $("[id^=page_]").removeClass('active');
            $("#page_" + target).addClass('active')
        };

        $(function() {
            {# TODO: 홈으로 올 때 모든 데이터 초기화? #}
            $('.js_page_toggle').on('click', function(e) {
                var _target = $(e.target);
                if (!_target.is('button')) {
                    _target = _target.parents('.js_page_toggle').eq(0);
                }
                var target = _target.data('target');
                activePage(target);
            });

            autosize($('.js_auto_resize'));
        })
    </script>
</head>
<body>
<header id="header" class="top_nav_header disactive">
    {# TODO: 뒤로가기 이미지 교체. 홈 버튼으로 바꾸자 #}
    <button class="history_back_button js_page_toggle" type="button" data-target="home">
        <span class="history_back_button_icon ti-angle-left"></span>
    </button>
</header>
{% include 'index.twig' %}

{% include 'write_letter.twig' %}

{% include 'find_letter.twig' %}

{% include 'find_letter_map.twig' %}

{% include 'read_letter.twig' %}

<div class="cover_loading">
    <div class="spinner">
        <div class="dot1"></div>
        <div class="dot2"></div>
    </div>
</div>

<script type="text/javascript">
    // 연세대학교 제3공학관
    var writeLetterLat = 37.561741;
    var writeLetterLng = 126.935105;

    var letter = null;

    function initMap() {
        var mapForWriteLetter = new google.maps.Map(document.getElementById("map_for_write_letter"), {
            center: {lat: writeLetterLat, lng: writeLetterLng},
            zoom: 16,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            zoomControl: true,
            mapTypeControl: false,
            scaleControl: true,
            streetViewControl: false,
            rotateControl: false
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                writeLetterLat = pos.lat;
                writeLetterLng = pos.lng;
                mapForWriteLetter.setCenter(pos);
            }, function () {
                {# TODO: 우리 서비스 이용 못함 #}
                console.log("HTML5 Geolocation failed (permission???)");
            });
        } else {
            {# TODO: 우리 서비스 이용 못함 #}
            console.log("HTML5 Geolocation not available");
        }

        mapForWriteLetter.addListener('center_changed', function() {
            var center = mapForWriteLetter.getCenter();
            writeLetterLat = center.lat();
            writeLetterLng = center.lng();
        });
    }

    $(function() {
        $("#write_letter_form").submit(function(event) {
            event.preventDefault();

            var $form = $(this);

            var $senderPhone1 = $form.find("select[name='sender_phone_number_1']");
            var $senderPhone2 = $form.find("input[name='sender_phone_number_2']");
            var $senderPhone3 = $form.find("input[name='sender_phone_number_3']");
            var usingSenderPhone = $senderPhone2.val().length > 0 || $senderPhone3.val().length > 0;

            var senderPhone = "";
            if (usingSenderPhone) {
                if (/^\d{3,4}$/.test($senderPhone2.val()) === false) {
                    alert("보내는 사람 번호가 올바르지 않습니다.");
                    $senderPhone2.focus();
                    return;
                }
                if (/^\d{4}$/.test($senderPhone3.val()) === false) {
                    alert("보내는 사람 번호가 올바르지 않습니다.");
                    $senderPhone3.focus();
                    return;
                }
                senderPhone = $senderPhone1.val() + "-" + $senderPhone2.val() + "-" + $senderPhone3.val();
            }

            var $receiverPhone1 = $form.find("select[name='receiver_phone_number_1']");
            var $receiverPhone2 = $form.find("input[name='receiver_phone_number_2']");
            var $receiverPhone3 = $form.find("input[name='receiver_phone_number_3']");
            var receiverPhone = $receiverPhone1.val() + "-" + $receiverPhone2.val() + "-" + $receiverPhone3.val();

            var $title = $form.find("input[name='title']");
            var $content = $form.find("textarea[name='content']");

            var params = {
                sender_phone: senderPhone,
                receiver_phone: receiverPhone,
                title: $title.val(),
                message: $content.val(),
                lat: writeLetterLat,
                lng: writeLetterLng
            };

            showLoading();
            $.post("/api/letter/write", params, function(data, textStatus, jqXHR) {
                hideLoading();
                alert(jqXHR.responseText);
                activePage("home");

                // 초기화
                $senderPhone1.val("010");
                $senderPhone2.val("");
                $senderPhone3.val("");

                $receiverPhone1.val("010");
                $receiverPhone2.val("");
                $receiverPhone3.val("");

                $title.val("");
                $content.val("");
            }).fail(function (jqXHR) {
                hideLoading();
                alert(jqXHR.responseText);
            });
        });

        $("#find_letter_form").submit(function(event) {
            event.preventDefault();

            var $form = $(this);

            var $receiverPhone1 = $form.find("select[name='receiver_phone_number_1']");
            var $receiverPhone2 = $form.find("input[name='receiver_phone_number_2']");
            var $receiverPhone3 = $form.find("input[name='receiver_phone_number_3']");
            var receiverPhone = $receiverPhone1.val() + "-" + $receiverPhone2.val() + "-" + $receiverPhone3.val();

            var $word1 = $form.find("input[name='location_word_1']");
            var $word2 = $form.find("input[name='location_word_2']");
            var $word3 = $form.find("input[name='location_word_3']");

            var params = {
                receiver_phone: receiverPhone,
                word1: $word1.val(),
                word2: $word2.val(),
                word3: $word3.val()
            };

            showLoading();
            $.post("/api/letter/find", params, function(data) {
                hideLoading();
                letter = data.letter;
                activePage("find_on_map");

                // 초기화
                $receiverPhone1.val("010");
                $receiverPhone2.val("");
                $receiverPhone3.val("");

                $word1.val("");
                $word2.val("");
                $word3.val("");
            }).fail(function (jqXHR) {
                hideLoading();
                alert(jqXHR.responseText);
            });
        });
    });

    function showLoading() {
        $(".cover_loading").addClass("active");
    }

    function hideLoading() {
        $(".cover_loading").removeClass("active");
    }

</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBNNrE7tuvdbalbsD2Yr8AE4ZPFOyYRgzs&libraries=geometry&callback=initMap" async defer></script>
</body>
</html>
