{% extends 'base.twig' %}

{% block title %}
    Seal Seek See
{% endblock %}

{% block css %}
    <style>
        body {
            padding-top: 30px;
        }

        #map {
            height: 400px;
            width: 100%;
            background: black;
        }

        #map:after {
            width: 22px;
            height: 40px;
            display: block;
            content: ' ';
            position: absolute;
            top: 50%; left: 50%;
            margin: -40px 0 0 -11px;
            background: url('https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi_hdpi.png');
            background-size: 22px 40px; /* Since I used the HiDPI marker version this compensates for the 2x size */
            pointer-events: none; /* This disables clicks on the marker. Not fully supported by all major browsers, though */
        }
    </style>
{% endblock %}

{% block container %}
    <div class="container">
        {# TODO: AJAX #}
        <form action="/api/letter/write" method="post" class="jumbotron">
            <input type="hidden" name="lat" required />
            <input type="hidden" name="lng" required />
            <p>보내는 사람 휴대전화 번호 : <input type="tel" name="sender_phone" pattern="^\d{3}-\d{3,4}-\d{4}$" value="{{ sender_phone }}" /></p>
            <p>받는 사람 휴대전화 번호 : <input type="tel" name="receiver_phone" pattern="^\d{3}-\d{3,4}-\d{4}$" required autofocus /></p>
            <p>편지 제목 : <input type="text" name="title" required /></p>
            <p>편지 내용</p>
            <p><textarea rows="10" name="message" style="width: 100%;" required></textarea></p>
            <p>위치</p>
            <p><div id="map"></div></p>
            <p><input type="submit" value="남기기" /></p>
        </form>
    </div>
{% endblock %}

{% block script %}
    <script type="text/javascript">
        // Note: This example requires that you consent to location sharing when
        // prompted by your browser. If you see the error "The Geolocation service
        // failed.", it means you probably did not give permission for the browser to
        // locate you.
        function initMap() {
            var map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 37.561741, lng: 126.935105},  // 연세대학교 제3공학관
                zoom: 16,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                zoomControl: true,
                mapTypeControl: false,
                scaleControl: true,
                streetViewControl: false,
                rotateControl: false
            });

            //var infoWindow = new google.maps.InfoWindow({map: map});

            // Try HTML5 geolocation.
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    // onSuccess
                    var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log("Accuracy: " + position.coords.accuracy + "meters");

//                    infoWindow.setPosition(pos);
//                    infoWindow.setContent('Location found.');
                    map.setCenter(pos);
                }, function(error) {
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            console.log("User denied the request for Geolocation.");
                            break;
                        case error.POSITION_UNAVAILABLE:
                            console.log("Location information is unavailable.");
                            break;
                        case error.TIMEOUT:
                            console.log("The request to get user location timed out.");
                            break;
                        case error.UNKNOWN_ERROR:
                            console.log(x.innerHTML = "An unknown error occurred.");
                            break;
                    }

                    // onFail
//                    handleLocationError(true, infoWindow, map.getCenter());
                });
            } else {
                // Browser doesn't support Geolocation
//                handleLocationError(false, infoWindow, map.getCenter());
            }

            map.addListener('center_changed', function() {
                var center = map.getCenter();
                $('input[name="lat"]').val(center.lat());
                $('input[name="lng"]').val(center.lng());
            });
        }

//        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
//            infoWindow.setPosition(pos);
//            infoWindow.setContent(browserHasGeolocation ?
//                'Error: The Geolocation service failed.' :
//                'Error: Your browser doesn\'t support geolocation.');
//        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDkyuDngdGBYtLYjWJ8hu_mKX-HfnN1evM&&callback=initMap"></script>
{% endblock %}
